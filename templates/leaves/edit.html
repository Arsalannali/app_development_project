{% extends "base.html" %}

{% block title %}Edit Leave Request - Bareera Intl. HR Module{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h1 class="mb-0"><i class="bi bi-pencil-square"></i> Edit Leave Request</h1>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="employee_id" class="form-label">Employee</label>
                        <select class="form-select" id="employee_id" name="employee_id" 
                                {% if session.get('role') not in ['Admin', 'HR Staff'] %}disabled{% endif %}>
                            {% for employee in employees %}
                            <option value="{{ employee.employee_id }}" 
                                    {% if leave.employee_id == employee.employee_id %}selected{% endif %}>
                                {{ employee.first_name }} {{ employee.last_name }} 
                                ({{ employee.department }} - {{ employee.designation }})
                            </option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="employee_id" value="{{ leave.employee_id }}">
                        {% if session.get('role') not in ['Admin', 'HR Staff'] %}
                        <div class="form-text">You can only edit your own leave requests.</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="leave_type" class="form-label">Leave Type</label>
                        <select class="form-select" id="leave_type" name="leave_type" required>
                            <option value="">Select leave type...</option>
                            <option value="Annual Leave" {% if leave.leave_type == 'Annual Leave' %}selected{% endif %}>Annual Leave</option>
                            <option value="Sick Leave" {% if leave.leave_type == 'Sick Leave' %}selected{% endif %}>Sick Leave</option>
                            <option value="Personal Leave" {% if leave.leave_type == 'Personal Leave' %}selected{% endif %}>Personal Leave</option>
                            <option value="Maternity Leave" {% if leave.leave_type == 'Maternity Leave' %}selected{% endif %}>Maternity Leave</option>
                            <option value="Paternity Leave" {% if leave.leave_type == 'Paternity Leave' %}selected{% endif %}>Paternity Leave</option>
                            <option value="Emergency Leave" {% if leave.leave_type == 'Emergency Leave' %}selected{% endif %}>Emergency Leave</option>
                            <option value="Unpaid Leave" {% if leave.leave_type == 'Unpaid Leave' %}selected{% endif %}>Unpaid Leave</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="start_date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="start_date" name="start_date" 
                                       value="{{ leave.start_date }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="end_date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="end_date" name="end_date" 
                                       value="{{ leave.end_date }}" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="reason" class="form-label">Reason for Leave</label>
                        <textarea class="form-control" id="reason" name="reason" rows="4" 
                                  placeholder="Please provide a detailed reason for your leave request..." required>{{ leave.reason }}</textarea>
                    </div>

                    <!-- Duration Display -->
                    <div class="mb-3">
                        <div class="alert alert-info">
                            <strong>Leave Duration:</strong> <span id="duration-display">Calculating...</span>
                        </div>
                    </div>

                    <!-- Current Status Display -->
                    <div class="mb-3">
                        <div class="alert alert-{{ 'warning' if leave.status == 'Pending' else ('success' if leave.status == 'Approved' else 'danger') }}">
                            <strong>Current Status:</strong> 
                            {% if leave.status == 'Pending' %}
                                <span class="badge bg-warning">Pending</span>
                            {% elif leave.status == 'Approved' %}
                                <span class="badge bg-success">Approved</span>
                            {% elif leave.status == 'Rejected' %}
                                <span class="badge bg-danger">Rejected</span>
                            {% endif %}
                            {% if leave.status != 'Pending' and session.get('role') not in ['Admin', 'HR Staff'] %}
                                <br><small class="mt-1 d-block">Note: Approved or rejected leaves cannot be edited by employees.</small>
                            {% endif %}
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('hr.leaves_list') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Leave Requests
                        </a>
                        <button type="submit" class="btn btn-primary" 
                                {% if leave.status not in ['Pending'] and session.get('role') not in ['Admin', 'HR Staff'] %}disabled{% endif %}>
                            <i class="bi bi-check-circle"></i> Update Leave Request
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Leave Request Information -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Leave Request Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Leave ID:</strong> {{ leave.leave_id }}<br>
                        <strong>Applied Date:</strong> {{ leave.applied_date }}
                    </div>
                    <div class="col-md-6">
                        {% if leave.approved_date %}
                        <strong>Approved Date:</strong> {{ leave.approved_date }}<br>
                        <strong>Approved By:</strong> {{ leave.approved_by }}
                        {% endif %}
                    </div>
                </div>
                {% if leave.comments %}
                <div class="mt-3">
                    <strong>Comments:</strong><br>
                    <div class="alert alert-light">{{ leave.comments }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Calculate and display leave duration
    function calculateDuration() {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (end >= start) {
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('duration-display').textContent = diffDays + ' day' + (diffDays > 1 ? 's' : '');
            } else {
                document.getElementById('duration-display').textContent = 'End date must be after start date';
            }
        } else {
            document.getElementById('duration-display').textContent = 'Select dates to see duration';
        }
    }
    
    // Add event listeners
    document.getElementById('start_date').addEventListener('change', calculateDuration);
    document.getElementById('end_date').addEventListener('change', calculateDuration);
    
    // Calculate initial duration
    calculateDuration();
</script>
{% endblock %}
{% endblock %}
